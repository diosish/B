<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 10px;
            padding-bottom: 80px;
        }

        .telegram-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .telegram-button {
            background: var(--tg-theme-button-color, #2678b6);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .navigation-menu {
            display: flex;
            justify-content: space-around;
            background: var(--tg-theme-bg-color, #ffffff);
            border-top: 1px solid var(--tg-theme-hint-color, #999999);
            padding: 10px 5px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--tg-theme-text-color, #000000);
            font-size: 12px;
            padding: 8px 4px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            flex: 1;
        }

        .nav-btn.active {
            background: var(--tg-theme-button-color, #2678b6);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="telegram-card">
            <h3>üìÖ –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
            <div class="row mb-3">
                <div class="col-6">
                    <input type="text" class="form-control form-control-sm" id="cityFilter" placeholder="üîç –ì–æ—Ä–æ–¥">
                </div>
                <div class="col-6">
                    <select class="form-control form-control-sm" id="workTypeFilter">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã —Ä–∞–±–æ—Ç</option>
                        <option value="—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</option>
                        <option value="–ª–æ–≥–∏—Å—Ç–∏–∫–∞">üì¶ –õ–æ–≥–∏—Å—Ç–∏–∫–∞</option>
                        <option value="—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ</option>
                        <option value="–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ">üí¨ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="eventsList">
            <div class="telegram-card text-center">
                <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è...</p>
            </div>
        </div>
    </div>

    <div class="navigation-menu">
        <button class="nav-btn" onclick="goToProfile()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="nav-btn active" onclick="goToEvents()">üìÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</button>
        <button class="nav-btn" onclick="goToApplications()">üìã –ó–∞—è–≤–∫–∏</button>
    </div>

    <script>
        let tg = window.Telegram?.WebApp;
        let currentUser = null;

        function init() {
            if (tg) {
                tg.ready();
                tg.expand();
                currentUser = tg.initDataUnsafe?.user || { id: 123456789 };

                tg.MainButton.setText('üè† –ì–ª–∞–≤–Ω–∞—è');
                tg.MainButton.show();
                tg.MainButton.onClick(() => {
                    window.location.href = '/';
                });
            }

            loadEvents();
        }

        async function loadEvents() {
            try {
                const response = await fetch('/api/events/');
                const events = await response.json();
                displayEvents(events);
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('eventsList').innerHTML =
                    '<div class="telegram-card"><p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p></div>';
            }
        }

        function displayEvents(events) {
            const eventsList = document.getElementById('eventsList');

            if (events.length === 0) {
                eventsList.innerHTML = '<div class="telegram-card"><p>üì≠ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p></div>';
                return;
            }

            eventsList.innerHTML = events.map(event => `
                <div class="telegram-card" style="border-left: 4px solid #2678b6;">
                    <h6><strong>${event.title}</strong></h6>
                    <p>${event.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>

                    <div class="row">
                        <div class="col-6">
                            <small>üìç ${event.city || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small>
                        </div>
                        <div class="col-6 text-end">
                            <small><strong>üí∞ ${event.payment || 0} ‚ÇΩ</strong></small>
                        </div>
                    </div>

                    ${event.date ? `<small>üìÖ ${new Date(event.date).toLocaleDateString('ru-RU')}</small><br>` : ''}
                    ${event.work_type ? `<small>üè∑Ô∏è ${event.work_type}</small><br>` : ''}
                    ${event.duration ? `<small>‚è∞ ${event.duration} —á</small>` : ''}

                    <button class="telegram-button" onclick="applyToEvent(${event.id}, '${event.title}')">
                        ‚úã –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è
                    </button>
                </div>
            `).join('');
        }

        async function applyToEvent(eventId, eventTitle) {
            try {
                const response = await fetch('/api/volunteers/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_id: eventId,
                        volunteer_id: currentUser.id
                    })
                });

                if (response.ok) {
                    if (tg && tg.showAlert) {
                        tg.showAlert(`‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ "${eventTitle}" –ø–æ–¥–∞–Ω–∞!`);
                    } else {
                        alert(`‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ "${eventTitle}" –ø–æ–¥–∞–Ω–∞!`);
                    }
                } else {
                    throw new Error('Failed to apply');
                }
            } catch (error) {
                console.error('Error applying:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∞—á–µ –∑–∞—è–≤–∫–∏');
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∞—á–µ –∑–∞—è–≤–∫–∏');
                }
            }
        }

        function goToProfile() {
            window.location.href = '/volunteer/profile';
        }

        function goToEvents() {
            // –£–∂–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
        }

        function goToApplications() {
            window.location.href = '/volunteer/applications';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>