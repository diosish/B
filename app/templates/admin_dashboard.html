<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            font-size: 14px;
        }

        .admin-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .action-btn {
            background: var(--tg-theme-button-color, #2678b6);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            width: calc(50% - 10px);
        }

        .danger-btn {
            background: #dc3545;
        }

        .warning-btn {
            background: #ffc107;
            color: #000;
        }

        .user-list, .event-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item, .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #eee);
        }

        .user-info, .event-info {
            flex: 1;
        }

        .user-actions, .event-actions {
            display: flex;
            gap: 5px;
        }

        .small-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .btn-edit {
            background: #17a2b8;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-activate {
            background: #28a745;
            color: white;
        }

        .btn-deactivate {
            background: #6c757d;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 20px;
        }

        .success {
            color: #28a745;
            text-align: center;
            padding: 10px;
            background: #d4edda;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .action-btn {
                width: 100%;
                margin: 5px 0;
            }

            .user-actions, .event-actions {
                flex-direction: column;
                gap: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="admin-card">
            <h2>‚öôÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
            <div id="successMessage" style="display: none;"></div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="admin-card">
            <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
            <div class="stats-grid" id="statsGrid">
                <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...</div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <div class="admin-card">
            <h4>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
            <div style="margin-bottom: 15px;">
                <button class="action-btn" onclick="loadUsers()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <button class="action-btn warning-btn" onclick="exportUsers()">üìä –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
            </div>
            <div id="usersList" class="user-list">
                <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏ -->
        <div class="admin-card">
            <h4>üìÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h4>
            <div style="margin-bottom: 15px;">
                <button class="action-btn" onclick="loadEvents()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <button class="action-btn danger-btn" onclick="cleanupOldEvents()">üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö</button>
            </div>
            <div id="eventsList" class="event-list">
                <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è...</div>
            </div>
        </div>

        <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="admin-card">
            <h4>üîß –°–∏—Å—Ç–µ–º–∞</h4>
            <button class="action-btn" onclick="sendTestNotification()">üì± –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</button>
            <button class="action-btn warning-btn" onclick="generateReport()">üìà –û—Ç—á–µ—Ç —Å–∏—Å—Ç–µ–º—ã</button>
            <button class="action-btn danger-btn" onclick="confirmDangerousAction('clearLogs')">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram?.WebApp;
        let currentUser = null;

        async function init() {
            if (tg) {
                tg.ready();
                tg.expand();
                currentUser = tg.initDataUnsafe?.user || {
                    id: 123456789,
                    first_name: 'Test',
                    last_name: 'User'
                };

                tg.MainButton.setText('üè† –ì–ª–∞–≤–Ω–∞—è');
                tg.MainButton.show();
                tg.MainButton.onClick(() => {
                    window.location.href = '/';
                });
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            if (!await checkAdminAccess()) {
                document.body.innerHTML = `
                    <div class="admin-card error">
                        <h3>‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h3>
                        <p>–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
                        <button class="action-btn" onclick="window.location.href='/'">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
                    </div>
                `;
                return;
            }

            await loadStats();
            await loadUsers();
            await loadEvents();
        }

        function getAuthHeaders() {
            return {
                'Authorization': tg ? tg.initData : 'test_data'
            };
        }

        async function checkAdminAccess() {
            try {
                const response = await fetch('/api/admin/check', {
                    headers: getAuthHeaders()
                });
                return response.ok;
            } catch (error) {
                console.error('Error checking admin access:', error);
                return false;
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const stats = await response.json();
                    displayStats(stats);
                } else {
                    throw new Error('Failed to load stats');
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('statsGrid').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
            }
        }

        function displayStats(stats) {
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total_users || 0}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_volunteers || 0}</div>
                    <div class="stat-label">–í–æ–ª–æ–Ω—Ç—ë—Ä—ã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_organizers || 0}</div>
                    <div class="stat-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_events || 0}</div>
                    <div class="stat-label">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.active_events || 0}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_applications || 0}</div>
                    <div class="stat-label">–ó–∞—è–≤–∫–∏</div>
                </div>
            `;
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const users = await response.json();
                    displayUsers(users.slice(0, 50)); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 50
                } else {
                    throw new Error('Failed to load users');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersList').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
            }
        }

        function displayUsers(users) {
            if (users.length === 0) {
                document.getElementById('usersList').innerHTML = '<div class="error">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                return;
            }

            document.getElementById('usersList').innerHTML = users.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <strong>${user.full_name}</strong><br>
                        <small>
                            ${user.role === 'volunteer' ? 'üë•' : user.role === 'organizer' ? 'üè¢' : '‚öôÔ∏è'} ${user.role} ‚Ä¢
                            ${user.city || '–ë–µ–∑ –≥–æ—Ä–æ–¥–∞'} ‚Ä¢
                            ${user.is_active ? 'üü¢' : 'üî¥'}
                        </small>
                    </div>
                    <div class="user-actions">
                        <button class="small-btn btn-edit" onclick="editUser(${user.id})">‚úèÔ∏è</button>
                        <button class="small-btn ${user.is_active ? 'btn-deactivate' : 'btn-activate'}"
                                onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                            ${user.is_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function loadEvents() {
            try {
                const response = await fetch('/api/admin/events', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const events = await response.json();
                    displayEvents(events.slice(0, 30)); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 30
                } else {
                    throw new Error('Failed to load events');
                }
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('eventsList').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>';
            }
        }

        function displayEvents(events) {
            if (events.length === 0) {
                document.getElementById('eventsList').innerHTML = '<div class="error">–ù–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>';
                return;
            }

            document.getElementById('eventsList').innerHTML = events.map(event => `
                <div class="event-item">
                    <div class="event-info">
                        <strong>${event.title}</strong><br>
                        <small>
                            üìç ${event.city || '–ë–µ–∑ –≥–æ—Ä–æ–¥–∞'} ‚Ä¢
                            üí∞ ${event.payment || 0} ‚ÇΩ ‚Ä¢
                            ${event.status === 'active' ? 'üü¢' : event.status === 'completed' ? '‚ö™' : 'üî¥'} ${event.status}
                        </small>
                    </div>
                    <div class="event-actions">
                        <button class="small-btn btn-edit" onclick="editEvent(${event.id})">‚úèÔ∏è</button>
                        <button class="small-btn btn-delete" onclick="deleteEvent(${event.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        async function toggleUserStatus(userId, activate) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ is_active: activate })
                });

                if (response.ok) {
                    showSuccess(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${activate ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'}`);
                    await loadUsers();
                } else {
                    throw new Error('Failed to update user status');
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/events/${eventId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showSuccess('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                    await loadEvents();
                    await loadStats();
                } else {
                    throw new Error('Failed to delete event');
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
                }
            }
        }

        function editUser(userId) {
            if (tg && tg.showAlert) {
                tg.showAlert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }

        function editEvent(eventId) {
            if (tg && tg.showAlert) {
                tg.showAlert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }

        async function exportUsers() {
            try {
                const response = await fetch('/api/admin/export/users', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showSuccess('–≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω');
                } else {
                    throw new Error('Failed to export users');
                }
            } catch (error) {
                console.error('Error exporting users:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                }
            }
        }

        async function cleanupOldEvents() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/cleanup/events', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(`–£–¥–∞–ª–µ–Ω–æ ${result.deleted_count} —Å—Ç–∞—Ä—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π`);
                    await loadEvents();
                    await loadStats();
                } else {
                    throw new Error('Failed to cleanup events');
                }
            } catch (error) {
                console.error('Error cleaning up events:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
                }
            }
        }

        function sendTestNotification() {
            if (tg && tg.showAlert) {
                tg.showAlert('üì± –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            }
            showSuccess('–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
        }

        function generateReport() {
            showSuccess('–û—Ç—á–µ—Ç —Å–∏—Å—Ç–µ–º—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º');
        }

        function confirmDangerousAction(action) {
            if (confirm('–≠—Ç–æ –æ–ø–∞—Å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                showSuccess('–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>