<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–∑—ã–≤—ã –æ –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞—Ö</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 10px;
        }

        .telegram-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .volunteer-card {
            border-left: 4px solid var(--tg-theme-button-color, #2678b6);
            position: relative;
        }

        .rating-input {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }

        .star {
            font-size: 24px;
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
        }

        .star.active,
        .star:hover {
            color: #ffc107;
        }

        .review-form {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            display: none;
        }

        .review-form.active {
            display: block;
        }

        .form-control {
            border-radius: 6px;
            border: 1px solid var(--tg-theme-hint-color, #999);
            padding: 8px 12px;
            margin-bottom: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .btn-review {
            background: var(--tg-theme-button-color, #2678b6);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            margin: 4px;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .volunteer-rating {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #ffc107;
            color: #000;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .no-volunteers {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #666);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="telegram-card">
            <h3>‚≠ê –û—Ç–∑—ã–≤—ã –æ –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞—Ö</h3>
            <div id="eventInfo">
                <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏...</p>
            </div>
        </div>

        <div id="volunteersList">
            <div class="loading">
                <div class="spinner-border" role="status"></div>
                <p>–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤...</p>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram?.WebApp;
        let currentUser = null;
        let eventId = null;
        let eventData = null;
        let volunteers = [];

        function init() {
            if (tg) {
                tg.ready();
                tg.expand();

                currentUser = tg.initDataUnsafe?.user || {
                    id: 123456789,
                    first_name: 'Test Organizer'
                };

                tg.MainButton.setText('üè† –ù–∞–∑–∞–¥ –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º');
                tg.MainButton.show();
                tg.MainButton.onClick(() => {
                    window.location.href = '/organizer/events';
                });
            } else {
                currentUser = {
                    id: 123456789,
                    first_name: 'Test Organizer'
                };
            }

            // –ü–æ–ª—É—á–∞–µ–º ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            eventId = urlParams.get('event_id');

            if (eventId) {
                loadEventData();
                loadReviewableVolunteers();
            } else {
                document.getElementById('volunteersList').innerHTML = `
                    <div class="telegram-card">
                        <div class="no-volunteers">
                            <p>‚ùå ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω</p>
                        </div>
                    </div>
                `;
            }
        }

        function getAuthHeaders() {
            const headers = {};
            if (tg && tg.initData) {
                headers['Authorization'] = tg.initData;
            } else {
                headers['Authorization'] = 'test_data';
            }
            return headers;
        }

        async function loadEventData() {
            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    eventData = await response.json();
                    displayEventInfo();
                }
            } catch (error) {
                console.error('Error loading event data:', error);
            }
        }

        function displayEventInfo() {
            document.getElementById('eventInfo').innerHTML = `
                <h5>${eventData.title}</h5>
                <p><small>
                    üìç ${eventData.city || '–ù–µ —É–∫–∞–∑–∞–Ω'} ‚Ä¢
                    üí∞ ${eventData.payment || 0} ‚ÇΩ ‚Ä¢
                    üìÖ ${eventData.date ? new Date(eventData.date).toLocaleDateString('ru-RU') : '–ì–∏–±–∫–∞—è –¥–∞—Ç–∞'}
                </small></p>
            `;
        }

        async function loadReviewableVolunteers() {
            try {
                const response = await fetch(`/api/reviews/event/${eventId}/reviewable`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    volunteers = await response.json();
                    displayVolunteers();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to load volunteers');
                }
            } catch (error) {
                console.error('Error loading volunteers:', error);
                document.getElementById('volunteersList').innerHTML = `
                    <div class="telegram-card">
                        <div class="no-volunteers">
                            <p>‚ùå ${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        function displayVolunteers() {
            const container = document.getElementById('volunteersList');

            if (volunteers.length === 0) {
                container.innerHTML = `
                    <div class="telegram-card">
                        <div class="no-volunteers">
                            <h5>‚úÖ –í—Å–µ –æ—Ç–∑—ã–≤—ã –æ—Å—Ç–∞–≤–ª–µ–Ω—ã!</h5>
                            <p>–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤—ã –≤—Å–µ–º –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞–º —ç—Ç–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = volunteers.map((item, index) => {
                const volunteer = item.volunteer;
                return `
                    <div class="telegram-card volunteer-card">
                        <div class="volunteer-rating">‚≠ê ${volunteer.rating || 0}</div>

                        <h6><strong>${volunteer.full_name}</strong></h6>

                        <div style="font-size: 14px; color: var(--tg-theme-hint-color, #666); margin: 8px 0;">
                            <div>üìç ${volunteer.city || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            <div>üè∑Ô∏è ${volunteer.volunteer_type || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                            ${volunteer.skills ? `<div>üõ†Ô∏è ${volunteer.skills}</div>` : ''}
                        </div>

                        <button class="btn-review" onclick="showReviewForm(${index})">
                            ‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                        </button>

                        <div class="review-form" id="reviewForm${index}">
                            <h6>–û—Ü–µ–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞:</h6>

                            <div class="rating-input" id="rating${index}">
                                ${[1,2,3,4,5].map(star => `
                                    <span class="star" onclick="setRating(${index}, ${star})">‚≠ê</span>
                                `).join('')}
                            </div>

                            <textarea class="form-control" id="comment${index}" rows="3"
                                placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤ –æ —Ä–∞–±–æ—Ç–µ –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞..."></textarea>

                            <div style="margin-top: 8px;">
                                <button class="btn-review" onclick="submitReview(${index}, ${volunteer.id})">
                                    üíæ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                                </button>
                                <button class="btn-review btn-cancel" onclick="hideReviewForm(${index})">
                                    ‚ùå –û—Ç–º–µ–Ω–∞
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showReviewForm(index) {
            const form = document.getElementById(`reviewForm${index}`);
            form.classList.add('active');
        }

        function hideReviewForm(index) {
            const form = document.getElementById(`reviewForm${index}`);
            form.classList.remove('active');

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            setRating(index, 0);
            document.getElementById(`comment${index}`).value = '';
        }

        function setRating(index, rating) {
            const stars = document.querySelectorAll(`#rating${index} .star`);
            stars.forEach((star, starIndex) => {
                if (starIndex < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥
            document.getElementById(`rating${index}`).dataset.rating = rating;
        }

        async function submitReview(index, volunteerId) {
            const rating = parseInt(document.getElementById(`rating${index}`).dataset.rating) || 0;
            const comment = document.getElementById(`comment${index}`).value.trim();

            if (rating === 0) {
                if (tg && tg.showAlert) {
                    tg.showAlert('‚≠ê –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5 –∑–≤—ë–∑–¥');
                } else {
                    alert('‚≠ê –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 5 –∑–≤—ë–∑–¥');
                }
                return;
            }

            if (!comment) {
                if (tg && tg.showAlert) {
                    tg.showAlert('üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');
                } else {
                    alert('üìù –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');
                }
                return;
            }

            try {
                const response = await fetch('/api/reviews/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        volunteer_id: volunteerId,
                        event_id: parseInt(eventId),
                        rating: rating,
                        comment: comment
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Review submitted:', result);

                    if (tg && tg.showAlert) {
                        tg.showAlert('‚úÖ –û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!\n\n–†–µ–π—Ç–∏–Ω–≥ –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞ –æ–±–Ω–æ–≤–ª—ë–Ω.');
                    } else {
                        alert('‚úÖ –û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    loadReviewableVolunteers();

                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to submit review');
                }

            } catch (error) {
                console.error('‚ùå Error submitting review:', error);

                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞: ' + error.message);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞: ' + error.message);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>