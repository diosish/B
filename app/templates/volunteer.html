{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞{% endblock %}

{% block content %}
<!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞ -->
<div class="telegram-card">
    <h3>üë• –ü—Ä–æ—Ñ–∏–ª—å –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞</h3>
    <form id="volunteerForm">
        <div class="mb-3">
            <label class="form-label">–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
            <input type="text" class="form-control" id="fullName" required>
        </div>
        
        <div class="mb-3">
            <label class="form-label">–ì–æ—Ä–æ–¥</label>
            <input type="text" class="form-control" id="city" placeholder="–ú–æ—Å–∫–≤–∞">
        </div>
        
        <div class="mb-3">
            <label class="form-label">–¢–∏–ø –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞</label>
            <select class="form-control" id="volunteerType">
                <option value="—Å—Ç—É–¥–µ–Ω—Ç">üéì –°—Ç—É–¥–µ–Ω—Ç</option>
                <option value="—Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä">üíª –§—Ä–∏–ª–∞–Ω—Å–µ—Ä</option>
                <option value="–ø—Ä–æ—Ñ–∏">‚≠ê –ü—Ä–æ—Ñ–∏</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label class="form-label">–ù–∞–≤—ã–∫–∏ –∏ –æ–ø—ã—Ç</label>
            <textarea class="form-control" id="skills" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –Ω–∞–≤—ã–∫–∏ –∏ –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã..."></textarea>
        </div>
        
        <button type="submit" class="telegram-button">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </button>
    </form>
</div>

<!-- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
<div class="telegram-card">
    <h4>üìÖ –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h4>
    <div id="eventsList">
        <div class="text-center">
            <div class="spinner-border" role="status"></div>
            <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è...</p>
        </div>
    </div>
</div>

<!-- –ú–æ–∏ –∑–∞—è–≤–∫–∏ -->
<div class="telegram-card">
    <h4>üìã –ú–æ–∏ –∑–∞—è–≤–∫–∏</h4>
    <div id="applicationsList">
        <p class="text-muted">–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞—à–∏ –∑–∞—è–≤–∫–∏</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞
    function initVolunteerPage() {
        currentUser = tg.initDataUnsafe?.user || {
            id: 123456789,
            first_name: 'Test',
            last_name: 'User'
        };
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (currentUser) {
            document.getElementById('fullName').value = 
                `${currentUser.first_name} ${currentUser.last_name || ''}`.trim();
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        loadEvents();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        setupMainButton();
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
    function setupMainButton() {
        if (tg.MainButton) {
            tg.MainButton.setText('üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é');
            tg.MainButton.show();
            tg.MainButton.onClick(() => {
                window.location.href = '/';
            });
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    document.getElementById('volunteerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            telegram_id: currentUser.id,
            full_name: document.getElementById('fullName').value,
            city: document.getElementById('city').value,
            volunteer_type: document.getElementById('volunteerType').value,
            skills: document.getElementById('skills').value,
            role: 'volunteer'
        };
        
        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º...';
            submitBtn.disabled = true;
            
            const response = await sendToAPI('/api/volunteers/register', formData);
            
            if (response) {
                showNotification('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                
                // Vibration feedback if available
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è', true);
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            const submitBtn = document.querySelector('#volunteerForm button[type="submit"]');
            submitBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
            submitBtn.disabled = false;
        }
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
    async function loadEvents() {
        try {
            const response = await fetch('/api/events/', {
                headers: {
                    'Authorization': tg.initData || 'test_data'
                }
            });
            
            const events = await response.json();
            displayEvents(events);
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('eventsList').innerHTML = 
                '<p class="text-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>';
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
    function displayEvents(events) {
        const eventsList = document.getElementById('eventsList');
        
        if (events.length === 0) {
            eventsList.innerHTML = '<p class="text-muted">üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>';
            return;
        }
        
        eventsList.innerHTML = events.map(event => `
            <div class="telegram-card" style="margin-bottom: 12px; border-left: 4px solid var(--tg-theme-button-color);">
                <h6><strong>${event.title}</strong></h6>
                <p class="mb-2">${event.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                
                <div class="row text-small">
                    <div class="col-6">
                        <small>üìç ${event.city || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small>
                    </div>
                    <div class="col-6 text-end">
                        <small>üí∞ ${event.payment || 0} ‚ÇΩ</small>
                    </div>
                </div>
                
                ${event.date ? `<small class="text-muted">üìÖ ${new Date(event.date).toLocaleDateString('ru-RU')}</small><br>` : ''}
                ${event.work_type ? `<small class="text-muted">üè∑Ô∏è ${event.work_type}</small><br>` : ''}
                
                <button class="telegram-button" style="margin-top: 10px; padding: 8px 16px; font-size: 14px;" 
                        onclick="applyToEvent(${event.id}, '${event.title}')">
                    ‚úã –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è
                </button>
            </div>
        `).join('');
    }
    
    // –ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    async function applyToEvent(eventId, eventTitle) {
        try {
            const applicationData = {
                event_id: eventId,
                volunteer_id: currentUser.id
            };
            
            const response = await sendToAPI('/api/volunteers/apply', applicationData);
            
            if (response) {
                showNotification(`‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ "${eventTitle}" –ø–æ–¥–∞–Ω–∞!`);
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
                loadApplications();
            }
        } catch (error) {
            if (error.message.includes('400')) {
                showNotification('‚ö†Ô∏è –í—ã —É–∂–µ –ø–æ–¥–∞–ª–∏ –∑–∞—è–≤–∫—É –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ');
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∞—á–µ –∑–∞—è–≤–∫–∏', true);
            }
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function loadApplications() {
        try {
            const response = await fetch(`/api/volunteers/applications/${currentUser.id}`, {
                headers: {
                    'Authorization': tg.initData || 'test_data'
                }
            });
            
            const applications = await response.json();
            displayApplications(applications);
        } catch (error) {
            console.error('Error loading applications:', error);
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
    function displayApplications(applications) {
        const applicationsList = document.getElementById('applicationsList');
        
        if (applications.length === 0) {
            applicationsList.innerHTML = '<p class="text-muted">üìù –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</p>';
            return;
        }
        
        applicationsList.innerHTML = applications.map(app => {
            const statusEmoji = {
                'pending': '‚è≥',
                'approved': '‚úÖ',
                'rejected': '‚ùå'
            };
            
            const statusText = {
                'pending': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
                'approved': '–û–¥–æ–±—Ä–µ–Ω–∞',
                'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'
            };
            
            return `
                <div class="telegram-card" style="margin-bottom: 8px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>–ó–∞—è–≤–∫–∞ #${app.id}</strong>
                            <br><small class="text-muted">${new Date(app.applied_at).toLocaleDateString('ru-RU')}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge" style="background: var(--tg-theme-button-color);">
                                ${statusEmoji[app.status]} ${statusText[app.status]}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram
        setTimeout(initVolunteerPage, 500);
    });
</script>
{% endblock %}
