{% extends "base_new.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞{% endblock %}

{% block content %}
<div class="telegram-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>üè¢ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
        <button id="editBtn" class="edit-btn" onclick="toggleEditMode()">
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
    </div>

    <div id="profileForm">
        <div class="profile-field" data-field="full_name">
            <div class="field-label">–ü–æ–ª–Ω–æ–µ –∏–º—è / –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
            <div class="field-value" id="fullName">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
            <input type="text" class="field-input" id="fullNameInput" style="display: none;">
        </div>

        <div class="profile-field" data-field="org_type">
            <div class="field-label">–¢–∏–ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</div>
            <div class="field-value" id="orgType">–ù–µ —É–∫–∞–∑–∞–Ω</div>
            <select class="field-input" id="orgTypeInput" style="display: none;" onchange="updateOrgTypeFields()">
                <option value="—Ñ–∏–∑–ª–∏—Ü–æ">üë§ –§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</option>
                <option value="–ò–ü">üè™ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å</option>
                <option value="–û–û–û">üè¢ –û–û–û</option>
                <option value="–ù–ö–û">ü§ù –ù–ö–û</option>
            </select>
        </div>

        <div class="profile-field" data-field="inn" id="innField">
            <div class="field-label">–ò–ù–ù</div>
            <div class="field-value" id="inn">–ù–µ —É–∫–∞–∑–∞–Ω</div>
            <input type="text" class="field-input" id="innInput" style="display: none;" placeholder="1234567890">
        </div>

        <div class="profile-field" data-field="city">
            <div class="field-label">–ì–æ—Ä–æ–¥</div>
            <div class="field-value" id="city">–ù–µ —É–∫–∞–∑–∞–Ω</div>
            <input type="text" class="field-input" id="cityInput" style="display: none;" placeholder="–ú–æ—Å–∫–≤–∞">
        </div>

        <div class="profile-field" data-field="description">
            <div class="field-label">–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</div>
            <div class="field-value" id="description">–ù–µ —É–∫–∞–∑–∞–Ω–æ</div>
            <textarea class="field-input" id="descriptionInput" style="display: none;" rows="3" placeholder="–ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–∞—à–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è..."></textarea>
        </div>

        <div class="profile-field">
            <div class="field-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
            <div class="field-value" id="createdAt">-</div>
        </div>

        <div class="edit-controls">
            <button class="edit-btn" onclick="saveProfile()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button class="edit-btn cancel" onclick="cancelEdit()">
                ‚ùå –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
</div>

<div id="loadingProfile" class="loading" style="display: none;">
    <div class="loading-spinner"></div>
    <p>–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å...</p>
</div>
{% endblock %}

{% block navigation %}
<div id="organizerNav"></div>
{% endblock %}

{% block scripts %}
<script>
let currentProfile = null;
let isEditMode = false;

async function initOrganizerProfile() {
    try {
        await new Promise(resolve => setTimeout(resolve, 500));

        if (!window.authManager.currentUser) {
            window.location.href = '/';
            return;
        }

        const authResult = await window.authManager.checkRegistration();

        if (authResult.registered) {
            currentProfile = authResult.user;

            if (currentProfile.role !== 'organizer') {
                window.location.href = '/volunteer/profile';
                return;
            }

            displayProfile(currentProfile);
        } else {
            await createNewOrganizerProfile();
        }

        setupNavigation();

    } catch (error) {
        console.error('Error loading profile:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
    }
}

async function createNewOrganizerProfile() {
    const user = window.authManager.currentUser;

    const newProfile = {
        telegram_id: user.id,
        full_name: `${user.first_name} ${user.last_name || ''}`.trim(),
        role: 'organizer'
    };

    try {
        const response = await fetch('/api/organizers/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newProfile)
        });

        if (response.ok) {
            const result = await response.json();
            currentProfile = result;
            displayProfile(currentProfile);

            toggleEditMode();
            window.authManager.showNotification('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', 'success');
        } else {
            throw new Error('Failed to create profile');
        }
    } catch (error) {
        console.error('Error creating profile:', error);
        showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
    }
}

function displayProfile(profile) {
    document.getElementById('fullName').textContent = profile.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
    document.getElementById('orgType').textContent = profile.org_type || '–ù–µ —É–∫–∞–∑–∞–Ω';
    document.getElementById('inn').textContent = profile.inn || '–ù–µ —É–∫–∞–∑–∞–Ω';
    document.getElementById('city').textContent = profile.city || '–ù–µ —É–∫–∞–∑–∞–Ω';
    document.getElementById('description').textContent = profile.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';

    if (profile.created_at) {
        const date = new Date(profile.created_at).toLocaleDateString('ru-RU');
        document.getElementById('createdAt').textContent = date;
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
    document.getElementById('fullNameInput').value = profile.full_name || '';
    document.getElementById('orgTypeInput').value = profile.org_type || '—Ñ–∏–∑–ª–∏—Ü–æ';
    document.getElementById('innInput').value = profile.inn || '';
    document.getElementById('cityInput').value = profile.city || '';
    document.getElementById('descriptionInput').value = profile.description || '';

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ–ª—è –ò–ù–ù
    updateOrgTypeFields();
}

function updateOrgTypeFields() {
    const orgType = document.getElementById('orgTypeInput').value;
    const innField = document.getElementById('innField');

    if (orgType === '—Ñ–∏–∑–ª–∏—Ü–æ') {
        innField.style.display = 'none';
    } else {
        innField.style.display = 'block';
    }
}

function toggleEditMode() {
    isEditMode = !isEditMode;
    const editBtn = document.getElementById('editBtn');
    const profileForm = document.getElementById('profileForm');

    if (isEditMode) {
        editBtn.textContent = 'üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä';
        profileForm.classList.add('edit-mode');

        document.querySelectorAll('.profile-field').forEach(field => {
            const value = field.querySelector('.field-value');
            const input = field.querySelector('.field-input');

            if (value && input) {
                value.style.display = 'none';
                input.style.display = 'block';
            }
        });
    } else {
        editBtn.textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        profileForm.classList.remove('edit-mode');

        document.querySelectorAll('.profile-field').forEach(field => {
            const value = field.querySelector('.field-value');
            const input = field.querySelector('.field-input');

            if (value && input) {
                value.style.display = 'block';
                input.style.display = 'none';
            }
        });
    }
}

async function saveProfile() {
    const profileData = {
        full_name: document.getElementById('fullNameInput').value,
        org_type: document.getElementById('orgTypeInput').value,
        inn: document.getElementById('innInput').value,
        city: document.getElementById('cityInput').value,
        description: document.getElementById('descriptionInput').value
    };

    // –£–±–∏—Ä–∞–µ–º –ò–ù–ù –¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü
    if (profileData.org_type === '—Ñ–∏–∑–ª–∏—Ü–æ') {
        profileData.inn = '';
    }

    try {
        document.getElementById('loadingProfile').style.display = 'block';

        const response = await window.authManager.updateProfile(profileData);

        if (response) {
            currentProfile = { ...currentProfile, ...profileData };
            displayProfile(currentProfile);
            toggleEditMode();

            window.authManager.showNotification('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
        }

    } catch (error) {
        console.error('Error saving profile:', error);
        window.authManager.showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
    } finally {
        document.getElementById('loadingProfile').style.display = 'none';
    }
}

function cancelEdit() {
    displayProfile(currentProfile);
    toggleEditMode();
}

function setupNavigation() {
    document.getElementById('organizerNav').innerHTML = window.nav.createOrganizerMenu();

    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.textContent.includes('–ü—Ä–æ—Ñ–∏–ª—å')) {
            btn.classList.add('active');
        }
    });

    window.authManager.setupMainButton('üè† –ì–ª–∞–≤–Ω–∞—è', () => {
        window.location.href = '/';
    });
}

function showError(message) {
    document.querySelector('.container').innerHTML = `
        <div class="telegram-card">
            <h4>‚ùå –û—à–∏–±–∫–∞</h4>
            <p>${message}</p>
            <button class="telegram-button" onclick="location.reload()">
                üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
        </div>
    `;
}

document.addEventListener('DOMContentLoaded', initOrganizerProfile);
</script>
{% endblock %>