{% extends "base_new.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞{% endblock %}

{% block content %}
<div class="telegram-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>üë• –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
        <button id="editBtn" class="edit-btn" onclick="toggleEditMode()">
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
    </div>

    <div id="profileForm">
        <div class="profile-field" data-field="full_name">
            <div class="field-label">–ü–æ–ª–Ω–æ–µ –∏–º—è</div>
            <div class="field-value" id="fullName">–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
            <input type="text" class="field-input" id="fullNameInput" style="display: none;">
        </div>

        <div class="profile-field" data-field="city">
            <div class="field-label">–ì–æ—Ä–æ–¥</div>
            <div class="field-value" id="city">–ù–µ —É–∫–∞–∑–∞–Ω</div>
            <input type="text" class="field-input" id="cityInput" style="display: none;" placeholder="–ú–æ—Å–∫–≤–∞">
        </div>

        <div class="profile-field" data-field="volunteer_type">
            <div class="field-label">–¢–∏–ø –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞</div>
            <div class="field-value" id="volunteerType">–ù–µ —É–∫–∞–∑–∞–Ω</div>
            <select class="field-input" id="volunteerTypeInput" style="display: none;">
                <option value="—Å—Ç—É–¥–µ–Ω—Ç">üéì –°—Ç—É–¥–µ–Ω—Ç</option>
                <option value="—Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä">üíª –§—Ä–∏–ª–∞–Ω—Å–µ—Ä</option>
                <option value="–ø—Ä–æ—Ñ–∏">‚≠ê –ü—Ä–æ—Ñ–∏</option>
            </select>
        </div>

        <div class="profile-field" data-field="skills">
            <div class="field-label">–ù–∞–≤—ã–∫–∏ –∏ –æ–ø—ã—Ç</div>
            <div class="field-value" id="skills">–ù–µ —É–∫–∞–∑–∞–Ω—ã</div>
            <textarea class="field-input" id="skillsInput" style="display: none;" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –Ω–∞–≤—ã–∫–∏ –∏ –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã..."></textarea>
        </div>

        <div class="profile-field">
            <div class="field-label">–†–µ–π—Ç–∏–Ω–≥</div>
            <div class="field-value" id="rating">‚≠ê 0.0</div>
        </div>

        <div class="profile-field">
            <div class="field-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
            <div class="field-value" id="createdAt">-</div>
        </div>

        <div class="edit-controls">
            <button class="edit-btn" onclick="saveProfile()">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button class="edit-btn cancel" onclick="cancelEdit()">
                ‚ùå –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </div>
</div>

<div id="loadingProfile" class="loading" style="display: none;">
    <div class="loading-spinner"></div>
    <p>–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å...</p>
</div>
{% endblock %}

{% block navigation %}
<div id="volunteerNav"></div>
{% endblock %}

{% block scripts %}
<script>
let currentProfile = null;
let isEditMode = false;

async function initVolunteerProfile() {
    try {
        await new Promise(resolve => setTimeout(resolve, 500));

        if (!window.authManager.currentUser) {
            window.location.href = '/';
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        const authResult = await window.authManager.checkRegistration();

        if (authResult.registered) {
            currentProfile = authResult.user;

            if (currentProfile.role !== 'volunteer') {
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä
                window.location.href = '/organizer/profile';
                return;
            }

            displayProfile(currentProfile);
        } else {
            // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
            await createNewVolunteerProfile();
        }

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        setupNavigation();

    } catch (error) {
        console.error('Error loading profile:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è');
    }
}

async function createNewVolunteerProfile() {
    const user = window.authManager.currentUser;

    const newProfile = {
        telegram_id: user.id,
        full_name: `${user.first_name} ${user.last_name || ''}`.trim(),
        role: 'volunteer'
    };

    try {
        const response = await fetch('/api/volunteers/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newProfile)
        });

        if (response.ok) {
            const result = await response.json();
            currentProfile = result;
            displayProfile(currentProfile);

            // –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            toggleEditMode();

            window.authManager.showNotification('üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å', 'success');
        } else {
            throw new Error('Failed to create profile');
        }
    } catch (error) {
        console.error('Error creating profile:', error);
        showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
    }
}

function displayProfile(profile) {
    document.getElementById('fullName').textContent = profile.full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
    document.getElementById('city').textContent = profile.city || '–ù–µ —É–∫–∞–∑–∞–Ω';
    document.getElementById('volunteerType').textContent = profile.volunteer_type || '–ù–µ —É–∫–∞–∑–∞–Ω';
    document.getElementById('skills').textContent = profile.skills || '–ù–µ —É–∫–∞–∑–∞–Ω—ã';
    document.getElementById('rating').textContent = `‚≠ê ${profile.rating || 0}`;

    if (profile.created_at) {
        const date = new Date(profile.created_at).toLocaleDateString('ru-RU');
        document.getElementById('createdAt').textContent = date;
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
    document.getElementById('fullNameInput').value = profile.full_name || '';
    document.getElementById('cityInput').value = profile.city || '';
    document.getElementById('volunteerTypeInput').value = profile.volunteer_type || '—Å—Ç—É–¥–µ–Ω—Ç';
    document.getElementById('skillsInput').value = profile.skills || '';
}

function toggleEditMode() {
    isEditMode = !isEditMode;
    const editBtn = document.getElementById('editBtn');
    const profileForm = document.getElementById('profileForm');

    if (isEditMode) {
        editBtn.textContent = 'üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä';
        profileForm.classList.add('edit-mode');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞, —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
        document.querySelectorAll('.profile-field').forEach(field => {
            const value = field.querySelector('.field-value');
            const input = field.querySelector('.field-input');

            if (value && input) {
                value.style.display = 'none';
                input.style.display = 'block';
            }
        });
    } else {
        editBtn.textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        profileForm.classList.remove('edit-mode');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
        document.querySelectorAll('.profile-field').forEach(field => {
            const value = field.querySelector('.field-value');
            const input = field.querySelector('.field-input');

            if (value && input) {
                value.style.display = 'block';
                input.style.display = 'none';
            }
        });
    }
}

async function saveProfile() {
    const profileData = {
        full_name: document.getElementById('fullNameInput').value,
        city: document.getElementById('cityInput').value,
        volunteer_type: document.getElementById('volunteerTypeInput').value,
        skills: document.getElementById('skillsInput').value
    };

    try {
        document.getElementById('loadingProfile').style.display = 'block';

        const response = await window.authManager.updateProfile(profileData);

        if (response) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            currentProfile = { ...currentProfile, ...profileData };
            displayProfile(currentProfile);
            toggleEditMode();

            window.authManager.showNotification('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!', 'success');
        }

    } catch (error) {
        console.error('Error saving profile:', error);
        window.authManager.showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
    } finally {
        document.getElementById('loadingProfile').style.display = 'none';
    }
}

function cancelEdit() {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    displayProfile(currentProfile);
    toggleEditMode();
}

function setupNavigation() {
    document.getElementById('volunteerNav').innerHTML = window.nav.createVolunteerMenu();

    // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.textContent.includes('–ü—Ä–æ—Ñ–∏–ª—å')) {
            btn.classList.add('active');
        }
    });

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    window.authManager.setupMainButton('üè† –ì–ª–∞–≤–Ω–∞—è', () => {
        window.location.href = '/';
    });
}

function showError(message) {
    document.querySelector('.container').innerHTML = `
        <div class="telegram-card">
            <h4>‚ùå –û—à–∏–±–∫–∞</h4>
            <p>${message}</p>
            <button class="telegram-button" onclick="location.reload()">
                üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
        </div>
    `;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', initVolunteerProfile);
</script>
{% endblock %}