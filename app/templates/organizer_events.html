<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/navigation.css" rel="stylesheet">
    <style>
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 10px;
        }

        .telegram-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .event-card {
            border-left: 4px solid var(--tg-theme-button-color, #2678b6);
            position: relative;
        }

        .event-card.completed {
            border-left-color: #28a745;
            opacity: 0.8;
        }

        .event-card.cancelled {
            border-left-color: #dc3545;
            opacity: 0.6;
        }

        .event-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            color: white;
            font-weight: 500;
        }

        .btn-applications {
            background: #17a2b8;
        }

        .btn-edit {
            background: #ffc107;
            color: #000;
        }

        .btn-complete {
            background: #28a745;
        }

        .btn-cancel {
            background: #dc3545;
        }

        .event-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-active {
            background: #28a745;
            color: white;
        }

        .status-completed {
            background: #6c757d;
            color: white;
        }

        .status-cancelled {
            background: #dc3545;
            color: white;
        }

        .event-stats {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 13px;
            color: var(--tg-theme-hint-color, #666);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .no-events {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #666);
        }

        .filter-tabs {
            display: flex;
            margin-bottom: 16px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
            padding: 4px;
        }

        .filter-tab {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            border: none;
            background: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            color: var(--tg-theme-text-color, #000);
        }

        .filter-tab.active {
            background: var(--tg-theme-button-color, #2678b6);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
    </style>
</head>
<body>
    <div class="container content-with-nav">
        <div class="telegram-card">
            <h3>üìã –ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>

            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterEvents('all')">–í—Å–µ</button>
                <button class="filter-tab" onclick="filterEvents('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                <button class="filter-tab" onclick="filterEvents('completed')">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
            </div>
        </div>

        <div id="eventsList">
            <div class="loading">
                <div class="spinner-border" role="status"></div>
                <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è...</p>
            </div>
        </div>
    </div>

    <div class="navigation-menu">
        <button class="nav-btn" onclick="nav.goToOrganizerProfile()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="nav-btn" onclick="nav.goToCreateEvent()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
        <button class="nav-btn active" onclick="nav.goToOrganizerEvents()">üìã –°–æ–±—ã—Ç–∏—è</button>
    </div>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script>
        let tg = window.Telegram?.WebApp;
        let currentUser = null;
        let allEvents = [];
        let currentFilter = 'all';

        async function init() {
            console.log('üìã Initializing organizer events page...');

            if (tg) {
                tg.ready();
                tg.expand();
                currentUser = tg.initDataUnsafe?.user || {
                    id: 123456789,
                    first_name: 'Test',
                    last_name: 'User'
                };

                tg.MainButton.setText('‚ûï –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ');
                tg.MainButton.show();
                tg.MainButton.onClick(() => {
                    window.location.href = '/organizer/create-event';
                });
            } else {
                currentUser = {
                    id: 123456789,
                    first_name: 'Test',
                    last_name: 'User'
                };
            }

            await loadEvents();
        }

        function getAuthHeaders() {
            const headers = {};
            if (tg && tg.initData) {
                headers['Authorization'] = tg.initData;
            } else {
                headers['Authorization'] = 'test_data';
            }
            return headers;
        }

        async function loadEvents() {
            try {
                console.log('üì° Loading events for organizer...');

                const response = await fetch(`/api/events/?organizer_id=${currentUser.id}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    allEvents = await response.json();
                    console.log('‚úÖ Events loaded:', allEvents.length);
                    displayEvents(allEvents);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Error loading events:', error);
                document.getElementById('eventsList').innerHTML = `
                    <div class="telegram-card">
                        <div class="no-events">
                            <p>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>
                            <button class="action-btn btn-applications" onclick="loadEvents()">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                        </div>
                    </div>
                `;
            }
        }

        function displayEvents(events) {
            const container = document.getElementById('eventsList');

            if (events.length === 0) {
                container.innerHTML = `
                    <div class="telegram-card">
                        <div class="no-events">
                            <h5>üìù –ù–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h5>
                            <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤</p>
                            <button class="action-btn btn-applications" onclick="nav.goToCreateEvent()">
                                ‚ûï –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            const statusLabels = {
                'active': 'üü¢ –ê–∫—Ç–∏–≤–Ω–æ',
                'completed': '‚ö™ –ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                'cancelled': 'üî¥ –û—Ç–º–µ–Ω–µ–Ω–æ'
            };

            container.innerHTML = events.map(event => `
                <div class="telegram-card event-card ${event.status}" data-status="${event.status}">
                    <div class="event-status status-${event.status}">
                        ${statusLabels[event.status] || 'üü° ' + event.status}
                    </div>

                    <h6><strong>${event.title}</strong></h6>

                    ${event.description ? `
                        <p style="font-size: 14px; margin: 8px 0; color: var(--tg-theme-hint-color, #666);">
                            ${event.description.substring(0, 120)}${event.description.length > 120 ? '...' : ''}
                        </p>
                    ` : ''}

                    <div class="event-stats">
                        <span>üìç ${event.city || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                        <span>üí∞ ${event.payment || 0} ‚ÇΩ</span>
                        <span>üìÖ ${event.date ? new Date(event.date).toLocaleDateString('ru-RU') : '–ì–∏–±–∫–∞—è –¥–∞—Ç–∞'}</span>
                    </div>

                    <div class="event-stats">
                        <span>üè∑Ô∏è ${event.work_type || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                        <span>‚è∞ ${event.duration ? event.duration + ' —á' : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                        <span>üìã <span id="applications-count-${event.id}">...</span> –∑–∞—è–≤–æ–∫</span>
                    </div>

                    <div class="event-actions">
                        <button class="action-btn btn-applications" onclick="viewApplications(${event.id})">
                            üìã –ó–∞—è–≤–∫–∏
                        </button>

                        ${event.status === 'active' ? `
                            <button class="action-btn btn-edit" onclick="editEvent(${event.id})">
                                ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                            <button class="action-btn btn-complete" onclick="completeEvent(${event.id})">
                                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å
                            </button>
                            <button class="action-btn btn-cancel" onclick="cancelEvent(${event.id})">
                                ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å
                            </button>
                        ` : ''}

                        ${event.status === 'completed' ? `
                            <button class="action-btn" style="background: #17a2b8;" onclick="viewReviews(${event.id})">
                                ‚≠ê –û—Ç–∑—ã–≤—ã
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
            events.forEach(event => loadApplicationsCount(event.id));
        }

        async function loadApplicationsCount(eventId) {
            try {
                const response = await fetch(`/api/applications/event/${eventId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const applications = await response.json();
                    const countElement = document.getElementById(`applications-count-${eventId}`);
                    if (countElement) {
                        countElement.textContent = applications.length;
                    }
                }
            } catch (error) {
                console.error(`Error loading applications count for event ${eventId}:`, error);
            }
        }

        function filterEvents(status) {
            currentFilter = status;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è
            let filteredEvents = allEvents;
            if (status !== 'all') {
                filteredEvents = allEvents.filter(event => event.status === status);
            }

            displayEvents(filteredEvents);
        }

        function viewReviews(eventId) {
            console.log(`‚≠ê Viewing reviews for event ${eventId}`);
            window.location.href = `/organizer/reviews?event_id=${eventId}`;
        }

        function viewApplications(eventId) {
            console.log(`üìã Viewing applications for event ${eventId}`);
            window.location.href = `/organizer/applications?event_id=${eventId}`;
        }

        function editEvent(eventId) {
            console.log(`‚úèÔ∏è Editing event ${eventId}`);
            if (tg && tg.showAlert) {
                tg.showAlert('‚úèÔ∏è –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            } else {
                alert('‚úèÔ∏è –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }

        async function completeEvent(eventId) {
            console.log(`‚úÖ Completing event ${eventId}`);

            const confirmed = confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ? –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤—ã –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞–º.');
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/events/${eventId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        status: 'completed'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Event completed:', result);

                    if (tg && tg.showAlert) {
                        tg.showAlert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤—ã –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞–º.');
                    } else {
                        alert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    loadEvents();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to complete event');
                }
            } catch (error) {
                console.error('‚ùå Error completing event:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ' + error.message);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ' + error.message);
                }
            }
        }

        async function cancelEvent(eventId) {
            console.log(`‚ùå Canceling event ${eventId}`);

            const confirmed = confirm('–û—Ç–º–µ–Ω–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?\n\n–í—Å–µ –≤–æ–ª–æ–Ω—Ç—ë—Ä—ã –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ.');
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/events/${eventId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        status: 'cancelled'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Event cancelled:', result);

                    if (tg && tg.showAlert) {
                        tg.showAlert('‚ùå –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.\n\n–í–æ–ª–æ–Ω—Ç—ë—Ä—ã –ø–æ–ª—É—á–∏–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.');
                    } else {
                        alert('‚ùå –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.');
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    loadEvents();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to cancel event');
                }
            } catch (error) {
                console.error('‚ùå Error canceling event:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ' + error.message);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: ' + error.message);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>