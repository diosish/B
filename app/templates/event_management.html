<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ–º</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 8px;
            font-size: 14px;
            padding-bottom: 20px;
        }

        .event-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .event-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .event-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .event-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 8px;
        }

        .status-active {
            background: #28a745;
            color: white;
        }

        .status-completed {
            background: #6c757d;
            color: white;
        }

        .status-cancelled {
            background: #dc3545;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: var(--tg-theme-hint-color, #666);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            color: white;
            font-weight: 500;
            font-size: 12px;
            min-height: 70px;
            gap: 6px;
        }

        .btn-primary {
            background: #17a2b8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-info {
            background: #007bff;
        }

        .action-icon {
            font-size: 20px;
        }

        .applications-summary {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .action-btn {
                padding: 12px 8px;
                font-size: 11px;
                min-height: 60px;
            }

            .action-icon {
                font-size: 16px;
            }
        }

        @media (max-width: 360px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .action-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingSection">
            <div class="loading">
                <div class="spinner-border" role="status"></div>
                <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è...</p>
            </div>
        </div>

        <div id="eventContent" style="display: none;">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
            <div class="event-header">
                <div class="event-title" id="eventTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div>üí∞ <span id="eventPayment">0</span> ‚ÇΩ</div>
                <div class="event-status" id="eventStatus">üü¢ –ê–∫—Ç–∏–≤–Ω–æ</div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="event-card">
                <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                <div class="stats-grid" id="statsGrid">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </div>
            </div>

            <!-- –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–∞—Ö -->
            <div class="event-card">
                <h4>üìã –ó–∞—è–≤–∫–∏</h4>
                <div class="applications-summary" id="applicationsSummary">
                    –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞—è–≤–∫–∞—Ö...
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="event-card">
                <h4>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h4>
                <div class="action-grid" id="actionsGrid">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </div>
            </div>
        </div>

        <div id="errorSection" style="display: none;">
            <div class="error">
                <h4>‚ùå –û—à–∏–±–∫–∞</h4>
                <p id="errorMessage">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</p>
                <button class="action-btn btn-secondary" onclick="window.history.back()">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram?.WebApp;
        let currentUser = null;
        let eventId = null;
        let eventData = null;
        let applicationsData = [];

        async function init() {
            console.log('‚öôÔ∏è Initializing event management page...');

            if (tg) {
                tg.ready();
                tg.expand();
                currentUser = tg.initDataUnsafe?.user;

                tg.MainButton.setText('üìã –ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
                tg.MainButton.show();
                tg.MainButton.onClick(() => {
                    window.location.href = '/organizer/events';
                });
            }

            // –ü–æ–ª—É—á–∞–µ–º ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            eventId = urlParams.get('event_id');

            if (!eventId) {
                showError('ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω');
                return;
            }

            await loadEventData();
            await loadApplicationsData();
        }

        function getAuthHeaders() {
            return {
                'Authorization': tg ? tg.initData : 'test_data'
            };
        }

        async function loadEventData() {
            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    eventData = await response.json();
                    displayEventHeader();
                } else {
                    throw new Error('Event not found');
                }
            } catch (error) {
                console.error('Error loading event:', error);
                showError('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            }
        }

        async function loadApplicationsData() {
            try {
                const response = await fetch(`/api/applications/event/${eventId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    applicationsData = await response.json();
                    displayContent();
                } else {
                    throw new Error('Failed to load applications');
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞—è–≤–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
                displayContent();
            }
        }

        function displayEventHeader() {
            document.getElementById('eventTitle').textContent = eventData.title;
            document.getElementById('eventPayment').textContent = eventData.payment || 0;

            const statusElement = document.getElementById('eventStatus');
            const statusLabels = {
                'active': 'üü¢ –ê–∫—Ç–∏–≤–Ω–æ',
                'completed': '‚ö™ –ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                'cancelled': 'üî¥ –û—Ç–º–µ–Ω–µ–Ω–æ'
            };
            statusElement.textContent = statusLabels[eventData.status] || `üü° ${eventData.status}`;
            statusElement.className = `event-status status-${eventData.status}`;
        }

        function displayContent() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('eventContent').style.display = 'block';

            displayStats();
            displayApplicationsSummary();
            displayActions();
        }

        function displayStats() {
            const totalApps = applicationsData.length;
            const pendingApps = applicationsData.filter(app => app.status === 'pending').length;
            const approvedApps = applicationsData.filter(app => app.status === 'approved').length;
            const rejectedApps = applicationsData.filter(app => app.status === 'rejected').length;

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-item">
                    <div class="stat-number">${totalApps}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${pendingApps}</div>
                    <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${approvedApps}</div>
                    <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω–æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">${rejectedApps}</div>
                    <div class="stat-label">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</div>
                </div>
            `;
        }

        function displayApplicationsSummary() {
            const pendingCount = applicationsData.filter(app => app.status === 'pending').length;
            const approvedCount = applicationsData.filter(app => app.status === 'approved').length;

            let summaryText = '';
            if (pendingCount > 0) {
                summaryText += `‚è≥ ${pendingCount} –∑–∞—è–≤–æ–∫ –æ–∂–∏–¥–∞—é—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è\n`;
            }
            if (approvedCount > 0) {
                summaryText += `‚úÖ ${approvedCount} –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤ –æ–¥–æ–±—Ä–µ–Ω–æ\n`;
            }
            if (!summaryText) {
                summaryText = 'üì≠ –ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ';
            }

            document.getElementById('applicationsSummary').textContent = summaryText.trim();
        }

        function displayActions() {
            const actions = [];

            // –ó–∞—è–≤–∫–∏ - –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã
            actions.push({
                icon: 'üìã',
                text: '–ó–∞—è–≤–∫–∏',
                action: 'viewApplications()',
                class: 'btn-primary'
            });

            // –≠–∫—Å–ø–æ—Ä—Ç - –µ—Å–ª–∏ –µ—Å—Ç—å –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
            const approvedCount = applicationsData.filter(app => app.status === 'approved').length;
            if (approvedCount > 0) {
                actions.push({
                    icon: 'üìÑ',
                    text: '–≠–∫—Å–ø–æ—Ä—Ç CSV',
                    action: 'exportVolunteers()',
                    class: 'btn-secondary'
                });
            }

            // –î–µ–π—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
            if (eventData.status === 'active') {
                actions.push({
                    icon: '‚úèÔ∏è',
                    text: '–ò–∑–º–µ–Ω–∏—Ç—å',
                    action: 'editEvent()',
                    class: 'btn-warning'
                });

                actions.push({
                    icon: '‚úÖ',
                    text: '–ó–∞–≤–µ—Ä—à–∏—Ç—å',
                    action: 'completeEvent()',
                    class: 'btn-success'
                });

                actions.push({
                    icon: '‚ùå',
                    text: '–û—Ç–º–µ–Ω–∏—Ç—å',
                    action: 'cancelEvent()',
                    class: 'btn-danger'
                });
            }

            // –û—Ç–∑—ã–≤—ã - –µ—Å–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            if (eventData.status === 'completed') {
                actions.push({
                    icon: '‚≠ê',
                    text: '–û—Ç–∑—ã–≤—ã',
                    action: 'manageReviews()',
                    class: 'btn-info'
                });
            }

            // –£–¥–∞–ª–µ–Ω–∏–µ - –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ
            actions.push({
                icon: 'üóëÔ∏è',
                text: '–£–¥–∞–ª–∏—Ç—å',
                action: 'deleteEvent()',
                class: 'btn-danger'
            });

            document.getElementById('actionsGrid').innerHTML = actions.map(action => `
                <button class="action-btn ${action.class}" onclick="${action.action}">
                    <div class="action-icon">${action.icon}</div>
                    <div>${action.text}</div>
                </button>
            `).join('');
        }

        function viewApplications() {
            window.location.href = `/organizer/applications?event_id=${eventId}`;
        }

        async function exportVolunteers() {
            try {
                const response = await fetch(`/api/export/volunteers/${eventId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `volunteers_${eventId}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    if (tg && tg.showAlert) {
                        tg.showAlert('üìÑ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!');
                    }
                } else {
                    throw new Error('Export failed');
                }
            } catch (error) {
                console.error('Error exporting:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
                }
            }
        }

        function editEvent() {
            if (tg && tg.showAlert) {
                tg.showAlert('‚úèÔ∏è –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }

        async function completeEvent() {
            const confirmed = confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?\n\n–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤—ã –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞–º.');
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/events/${eventId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ status: 'completed' })
                });

                if (response.ok) {
                    if (tg && tg.showAlert) {
                        tg.showAlert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
                    }
                    location.reload();
                } else {
                    throw new Error('Failed to complete event');
                }
            } catch (error) {
                console.error('Error completing event:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏');
                }
            }
        }

        async function cancelEvent() {
            const confirmed = confirm('–û—Ç–º–µ–Ω–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?\n\n–í—Å–µ –≤–æ–ª–æ–Ω—Ç—ë—Ä—ã –ø–æ–ª—É—á–∞—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ.');
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/events/${eventId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ status: 'cancelled' })
                });

                if (response.ok) {
                    if (tg && tg.showAlert) {
                        tg.showAlert('‚ùå –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                    }
                    location.reload();
                } else {
                    throw new Error('Failed to cancel event');
                }
            } catch (error) {
                console.error('Error canceling event:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ');
                }
            }
        }

        function manageReviews() {
            window.location.href = `/organizer/reviews?event_id=${eventId}`;
        }

        async function deleteEvent() {
            const confirmed = confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:\n- –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ\n- –í—Å–µ –∑–∞—è–≤–∫–∏\n- –í—Å–µ –æ—Ç–∑—ã–≤—ã\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
            if (!confirmed) return;

            const doubleConfirm = confirm('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!\n\n–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ù–ê–í–°–ï–ì–î–ê —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?');
            if (!doubleConfirm) return;

            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    if (tg && tg.showAlert) {
                        tg.showAlert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                    }
                    window.location.href = '/organizer/events';
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to delete event');
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
                }
            }
        }

        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>