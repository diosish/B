<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å - –ó–∞—â–∏—â–µ–Ω–Ω–∞—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            font-size: 14px;
        }

        .header-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .admin-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .action-btn {
            background: var(--tg-theme-button-color, #2678b6);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            width: calc(50% - 10px);
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .danger-btn {
            background: #dc3545;
        }

        .warning-btn {
            background: #ffc107;
            color: #000;
        }

        .success-btn {
            background: #28a745;
        }

        .user-list, .event-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item, .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #eee);
        }

        .user-info, .event-info {
            flex: 1;
        }

        .user-actions, .event-actions {
            display: flex;
            gap: 5px;
        }

        .small-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }

        .btn-edit {
            background: #17a2b8;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-activate {
            background: #28a745;
            color: white;
        }

        .btn-deactivate {
            background: #6c757d;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 20px;
        }

        .success {
            color: #28a745;
            text-align: center;
            padding: 10px;
            background: #d4edda;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .session-info {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .logout-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            cursor: pointer;
            float: right;
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .action-btn {
                width: 100%;
                margin: 5px 0;
            }

            .user-actions, .event-actions {
                flex-direction: column;
                gap: 3px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–µ—Å—Å–∏–∏ -->
        <div class="header-card">
            <h2>üîê –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h2>
            <p>–ó–∞—â–∏—â–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø</p>
            <button class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏ -->
        <div class="session-info">
            <strong>üìã –°–µ—Å—Å–∏—è:</strong> <span id="sessionInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</span><br>
            <strong>‚è∞ –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> <span id="lastActivity">–°–µ–π—á–∞—Å</span>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="successMessage" style="display: none;"></div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="admin-card">
            <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h4>
            <div class="stats-grid" id="statsGrid">
                <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...</div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <div class="admin-card">
            <h4>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h4>
            <div style="margin-bottom: 15px;">
                <button class="action-btn" onclick="loadUsers()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="action-btn warning-btn" onclick="exportUsers()">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
            <div id="usersList" class="user-list">
                <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
            </div>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏ -->
        <div class="admin-card">
            <h4>üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏</h4>
            <div style="margin-bottom: 15px;">
                <button class="action-btn" onclick="loadEvents()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="action-btn danger-btn" onclick="cleanupOldEvents()">üóëÔ∏è –û—á–∏—Å—Ç–∫–∞</button>
            </div>
            <div id="eventsList" class="event-list">
                <div class="loading">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è...</div>
            </div>
        </div>

        <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="admin-card">
            <h4>üîß –°–∏—Å—Ç–µ–º–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h4>
            <button class="action-btn success-btn" onclick="extendSession()">‚è∞ –ü—Ä–æ–¥–ª–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
            <button class="action-btn warning-btn" onclick="generateReport()">üìà –û—Ç—á–µ—Ç</button>
            <button class="action-btn" onclick="checkSessionStatus()">üîç –°—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram?.WebApp;

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–¥–º–∏–Ω –¥–∞—à–±–æ—Ä–¥–∞

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
        function getAdminHeaders() {
            return {
                'Content-Type': 'application/json',
                // Cookie –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ç–æ—Ç –∂–µ –¥–æ–º–µ–Ω
                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ Authorization –Ω–µ –Ω—É–∂–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è cookie –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–¥–º–∏–Ω–∫–∏
        async function adminApiRequest(url, options = {}) {
            try {
                const defaultOptions = {
                    credentials: 'include', // –í–∞–∂–Ω–æ: –≤–∫–ª—é—á–∞–µ–º cookies –≤ –∑–∞–ø—Ä–æ—Å
                    headers: getAdminHeaders(),
                    ...options
                };

                console.log(`üîê Admin API request: ${options.method || 'GET'} ${url}`);

                const response = await fetch(url, defaultOptions);

                if (response.status === 401) {
                    console.error('‚ùå Admin session expired, redirecting to login');
                    window.location.href = '/admin/login';
                    return null;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

                return response.json();
            } catch (error) {
                console.error('‚ùå Admin API error:', error);
                throw error;
            }
        }

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        async function loadStats() {
            try {
                const stats = await adminApiRequest('/api/admin/stats');
                if (stats) {
                    displayStats(stats);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('statsGrid').innerHTML =
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';
            }
        }

        async function loadUsers() {
            try {
                const users = await adminApiRequest('/api/admin/users');
                if (users) {
                    displayUsers(users.slice(0, 50)); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 50
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersList').innerHTML =
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
            }
        }

        async function loadEvents() {
            try {
                const events = await adminApiRequest('/api/admin/events');
                if (events) {
                    displayEvents(events.slice(0, 30)); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 30
                }
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('eventsList').innerHTML =
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>';
            }
        }

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π
        async function toggleUserStatus(userId, activate) {
            try {
                const result = await adminApiRequest(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ is_active: activate })
                });

                if (result) {
                    showSuccess(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${activate ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'}`);
                    await loadUsers();
                }
            } catch (error) {
                console.error('Error updating user status:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        async function deleteEvent(eventId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }

            try {
                const result = await adminApiRequest(`/api/admin/events/${eventId}`, {
                    method: 'DELETE'
                });

                if (result) {
                    showSuccess('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                    await loadEvents();
                    await loadStats();
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
            }
        }

        async function exportUsers() {
            try {
                console.log('üìä Starting user export...');

                const response = await fetch('/api/admin/export/users', {
                    credentials: 'include', // –í–∫–ª—é—á–∞–µ–º cookies
                    headers: getAdminHeaders()
                });

                if (response.status === 401) {
                    console.error('‚ùå Admin session expired');
                    window.location.href = '/admin/login';
                    return;
                }

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showSuccess('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to export users');
                }
            } catch (error) {
                console.error('Error exporting users:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            }
        }

        async function cleanupOldEvents() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π?')) {
                return;
            }

            try {
                const result = await adminApiRequest('/api/admin/cleanup/events', {
                    method: 'POST'
                });

                if (result) {
                    showSuccess(`–£–¥–∞–ª–µ–Ω–æ ${result.deleted_count} —Å—Ç–∞—Ä—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π`);
                    await loadEvents();
                    await loadStats();
                }
            } catch (error) {
                console.error('Error cleaning up events:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');
            }
        }

        async function checkAuthStatus() {
            try {
                const response = await fetch('/admin/auth/check', {
                    credentials: 'include'
                });

                const status = await response.json();

                if (!status.authenticated) {
                    console.error('‚ùå Not authenticated');
                    window.location.href = '/admin/login';
                    return;
                }

                document.getElementById('sessionInfo').textContent =
                    `${status.session_id} (${status.role})`;

            } catch (error) {
                console.error('Error checking auth status:', error);
                window.location.href = '/admin/login';
            }
        }

        async function extendSession() {
            try {
                const response = await fetch('/admin/auth/extend', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess('–°–µ—Å—Å–∏—è –ø—Ä–æ–¥–ª–µ–Ω–∞ –Ω–∞ 8 —á–∞—Å–æ–≤');
                } else {
                    throw new Error('Failed to extend session');
                }
            } catch (error) {
                console.error('Error extending session:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏');
            }
        }

        async function checkSessionStatus() {
            try {
                const response = await fetch('/admin/auth/sessions', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–π:\n\n–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏: ${result.stats.active_sessions}\n–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π: ${result.stats.total_sessions}\n–ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: ${result.stats.active_tokens}`);
                } else {
                    throw new Error('Failed to get session status');
                }
            } catch (error) {
                console.error('Error checking session status:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–π');
            }
        }

        async function logout() {
            try {
                const response = await fetch('/admin/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    console.log('‚úÖ Logout successful');
                } else {
                    console.error('‚ùå Logout failed');
                }
            } catch (error) {
                console.error('Error during logout:', error);
            } finally {
                // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = '/admin/login';
            }
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function displayStats(stats) {
            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total_users || 0}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_volunteers || 0}</div>
                    <div class="stat-label">–í–æ–ª–æ–Ω—Ç—ë—Ä—ã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_organizers || 0}</div>
                    <div class="stat-label">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_events || 0}</div>
                    <div class="stat-label">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.active_events || 0}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_applications || 0}</div>
                    <div class="stat-label">–ó–∞—è–≤–∫–∏</div>
                </div>
            `;
        }

        function displayUsers(users) {
            if (users.length === 0) {
                document.getElementById('usersList').innerHTML =
                    '<div class="error">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                return;
            }

            document.getElementById('usersList').innerHTML = users.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <strong>${user.full_name}</strong><br>
                        <small>
                            ${user.role === 'volunteer' ? 'üë•' : user.role === 'organizer' ? 'üè¢' : '‚öôÔ∏è'} ${user.role} ‚Ä¢
                            ${user.city || '–ë–µ–∑ –≥–æ—Ä–æ–¥–∞'} ‚Ä¢
                            ${user.is_active ? 'üü¢' : 'üî¥'}
                        </small>
                    </div>
                    <div class="user-actions">
                        <button class="small-btn ${user.is_active ? 'btn-deactivate' : 'btn-activate'}"
                                onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                            ${user.is_active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayEvents(events) {
            if (events.length === 0) {
                document.getElementById('eventsList').innerHTML =
                    '<div class="error">–ù–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>';
                return;
            }

            document.getElementById('eventsList').innerHTML = events.map(event => `
                <div class="event-item">
                    <div class="event-info">
                        <strong>${event.title}</strong><br>
                        <small>
                            üìç ${event.city || '–ë–µ–∑ –≥–æ—Ä–æ–¥–∞'} ‚Ä¢
                            üí∞ ${event.payment || 0} ‚ÇΩ ‚Ä¢
                            ${event.status === 'active' ? 'üü¢' : event.status === 'completed' ? '‚ö™' : 'üî¥'} ${event.status}
                        </small>
                    </div>
                    <div class="event-actions">
                        <button class="small-btn btn-delete" onclick="deleteEvent(${event.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function updateLastActivity() {
            document.getElementById('lastActivity').textContent =
                new Date().toLocaleTimeString('ru-RU');
        }

        function generateReport() {
            showSuccess('–û—Ç—á–µ—Ç —Å–∏—Å—Ç–µ–º—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            console.log('üîê Initializing secure admin dashboard...');

            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();

                tg.MainButton.setText('üö™ –í—ã–π—Ç–∏');
                tg.MainButton.show();
                tg.MainButton.onClick(logout);
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            await checkAuthStatus();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadStats();
            await loadUsers();
            await loadEvents();

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(updateLastActivity, 30000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>