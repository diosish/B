{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞{% endblock %}

{% block content %}
<!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞ -->
<div class="telegram-card">
    <h3>üè¢ –ü—Ä–æ—Ñ–∏–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞</h3>
    <form id="organizerForm">
        <div class="mb-3">
            <label class="form-label">–ü–æ–ª–Ω–æ–µ –∏–º—è / –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
            <input type="text" class="form-control" id="orgName" required>
        </div>

        <div class="mb-3">
            <label class="form-label">–¢–∏–ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</label>
            <select class="form-control" id="orgType">
                <option value="—Ñ–∏–∑–ª–∏—Ü–æ">üë§ –§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</option>
                <option value="–ò–ü">üè™ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å</option>
                <option value="–û–û–û">üè¢ –û–û–û</option>
                <option value="–ù–ö–û">ü§ù –ù–ö–û</option>
            </select>
        </div>

        <div class="mb-3" id="innField">
            <label class="form-label">–ò–ù–ù</label>
            <input type="text" class="form-control" id="inn" placeholder="–î–ª—è –ò–ü –∏ –û–û–û">
        </div>

        <div class="mb-3">
            <label class="form-label">–ì–æ—Ä–æ–¥</label>
            <input type="text" class="form-control" id="city" placeholder="–ú–æ—Å–∫–≤–∞">
        </div>

        <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</label>
            <textarea class="form-control" id="description" rows="3" placeholder="–ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–∞—à–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è..."></textarea>
        </div>

        <button type="submit" class="telegram-button">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </button>
    </form>
</div>

<!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
<div class="telegram-card">
    <h4>‚ûï –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h4>
    <form id="eventForm">
        <div class="mb-3">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</label>
            <input type="text" class="form-control" id="eventTitle" required placeholder="–ü–æ–º–æ—â—å –Ω–∞ –≤—ã—Å—Ç–∞–≤–∫–µ">
        </div>

        <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea class="form-control" id="eventDescription" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏ –∑–∞–¥–∞—á –¥–ª—è –≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤"></textarea>
        </div>

        <div class="row">
            <div class="col-6">
                <div class="mb-3">
                    <label class="form-label">–ì–æ—Ä–æ–¥</label>
                    <input type="text" class="form-control" id="eventCity">
                </div>
            </div>
            <div class="col-6">
                <div class="mb-3">
                    <label class="form-label">–û–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                    <input type="number" class="form-control" id="eventPayment" min="0" placeholder="1000">
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-6">
                <div class="mb-3">
                    <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                    <input type="datetime-local" class="form-control" id="eventDate">
                </div>
            </div>
            <div class="col-6">
                <div class="mb-3">
                    <label class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—á)</label>
                    <input type="number" class="form-control" id="eventDuration" min="1" placeholder="8">
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">–¢–∏–ø —Ä–∞–±–æ—Ç—ã</label>
            <select class="form-control" id="workType">
                <option value="—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</option>
                <option value="–ª–æ–≥–∏—Å—Ç–∏–∫–∞">üì¶ –õ–æ–≥–∏—Å—Ç–∏–∫–∞</option>
                <option value="—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</option>
                <option value="–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ">üí¨ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</option>
            </select>
        </div>

        <button type="submit" class="telegram-button">
            üöÄ –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
        </button>
    </form>
</div>

<!-- –ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è -->
<div class="telegram-card">
    <h4>üìã –ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h4>
    <div id="myEventsList">
        <div class="text-center">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <span class="ms-2">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞
    function initOrganizerPage() {
        currentUser = tg.initDataUnsafe?.user || {
            id: 123456789,
            first_name: 'Test',
            last_name: 'User'
        };

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (currentUser) {
            document.getElementById('orgName').value =
                `${currentUser.first_name} ${currentUser.last_name || ''}`.trim();
            document.getElementById('city').value = currentUser.city || '';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        document.getElementById('orgType').addEventListener('change', function() {
            const innField = document.getElementById('innField');
            const selectedType = this.value;

            if (selectedType === '—Ñ–∏–∑–ª–∏—Ü–æ') {
                innField.style.display = 'none';
                document.getElementById('inn').required = false;
            } else {
                innField.style.display = 'block';
                document.getElementById('inn').required = true;
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞
        loadMyEvents();

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        setupMainButton();
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–∞–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ Telegram
    function setupMainButton() {
        if (tg.MainButton) {
            tg.MainButton.setText('üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é');
            tg.MainButton.show();
            tg.MainButton.onClick(() => {
                window.location.href = '/';
            });
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞
    document.getElementById('organizerForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = {
            telegram_id: currentUser.id,
            full_name: document.getElementById('orgName').value,
            city: document.getElementById('city').value,
            org_type: document.getElementById('orgType').value,
            org_name: document.getElementById('orgName').value,
            inn: document.getElementById('inn').value,
            description: document.getElementById('description').value,
            role: 'organizer'
        };

        try {
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º...';
            submitBtn.disabled = true;

            const response = await sendToAPI('/api/organizers/register', formData);

            if (response) {
                showNotification('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');

                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è', true);

            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        } finally {
            const submitBtn = document.querySelector('#organizerForm button[type="submit"]');
            submitBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
            submitBtn.disabled = false;
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    document.getElementById('eventForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = {
            title: document.getElementById('eventTitle').value,
            description: document.getElementById('eventDescription').value,
            city: document.getElementById('eventCity').value,
            payment: parseFloat(document.getElementById('eventPayment').value) || 0,
            date: document.getElementById('eventDate').value || null,
            duration: parseInt(document.getElementById('eventDuration').value) || 1,
            work_type: document.getElementById('workType').value
        };

        try {
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ –°–æ–∑–¥–∞—ë–º...';
            submitBtn.disabled = true;

            const response = await fetch(`/api/events/?organizer_id=${currentUser.id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': tg.initData || 'test_data'
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                showNotification('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
                document.getElementById('eventForm').reset();
                loadMyEvents(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫

                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }
            } else {
                throw new Error('Failed to create event');
            }
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', true);

            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
        } finally {
            const submitBtn = document.querySelector('#eventForm button[type="submit"]');
            submitBtn.innerHTML = 'üöÄ –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ';
            submitBtn.disabled = false;
        }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞
    async function loadMyEvents() {
        try {
            const response = await fetch(`/api/events/?organizer_id=${currentUser.id}`, {
                headers: {
                    'Authorization': tg.initData || 'test_data'
                }
            });

            const events = await response.json();
            displayMyEvents(events);
        } catch (error) {
            console.error('Error loading my events:', error);
            document.getElementById('myEventsList').innerHTML =
                '<p class="text-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>';
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞
    function displayMyEvents(events) {
        const myEventsList = document.getElementById('myEventsList');

        if (events.length === 0) {
            myEventsList.innerHTML = '<p class="text-muted">üìù –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>';
            return;
        }

        myEventsList.innerHTML = events.map(event => `
            <div class="telegram-card" style="margin-bottom: 12px; border-left: 4px solid var(--tg-theme-button-color);">
                <div class="d-flex justify-content-between align-items-start">
                    <div style="flex-grow: 1;">
                        <h6><strong>${event.title}</strong></h6>
                        <small class="text-muted">
                            üìç ${event.city || '–ù–µ —É–∫–∞–∑–∞–Ω'} ‚Ä¢
                            üí∞ ${event.payment || 0} ‚ÇΩ ‚Ä¢
                            ${event.status === 'active' ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–æ' : 'üî¥ –ó–∞–≤–µ—Ä—à–µ–Ω–æ'}
                        </small>
                    </div>
                </div>

                ${event.description ? `<p class="mt-2 mb-2" style="font-size: 14px;">${event.description}</p>` : ''}

                <div class="row mt-2">
                    <div class="col-4">
                        <button class="telegram-button" style="width: 100%; padding: 6px 8px; font-size: 12px;"
                                onclick="viewEventApplications(${event.id})">
                            üìã –ó–∞—è–≤–∫–∏
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="telegram-button" style="width: 100%; padding: 6px 8px; font-size: 12px;"
                                onclick="editEvent(${event.id})">
                            ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="telegram-button" style="width: 100%; padding: 6px 8px; font-size: 12px;"
                                onclick="toggleEventStatus(${event.id}, '${event.status}')">
                            ${event.status === 'active' ? '‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å'}
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    function viewEventApplications(eventId) {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞—è–≤–æ–∫
        window.location.href = `/organizer/applications?event_id=${eventId}`;
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    function editEvent(eventId) {
        showNotification('‚úèÔ∏è –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
    }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    async function toggleEventStatus(eventId, currentStatus) {
        const newStatus = currentStatus === 'active' ? 'completed' : 'active';

        try {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç API –∑–∞–ø—Ä–æ—Å –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            showNotification(`‚úÖ –°—Ç–∞—Ç—É—Å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: ${newStatus}`);
            setTimeout(loadMyEvents, 1000);
        } catch (error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', true);
        }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ API
    async function sendToAPI(endpoint, data) {
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': tg.initData || 'test_data'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    function showNotification(message, isError = false) {
        if (tg.showAlert) {
            tg.showAlert(message);
        } else {
            alert(message);
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initOrganizerPage, 500);
    });
</script>
{% endblock %}