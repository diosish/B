<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/navigation.css" rel="stylesheet">
    <style>
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 10px;
        }

        .telegram-card {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .telegram-button {
            background: var(--tg-theme-button-color, #2678b6);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid var(--tg-theme-hint-color, #999999);
            padding: 12px;
            margin-bottom: 12px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .error {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .required {
            color: #dc3545;
        }

        .form-help {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: -8px;
            margin-bottom: 12px;
        }

        .danger-zone {
            border: 2px dashed #dc3545;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            background: rgba(220, 53, 69, 0.1);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container content-with-nav">
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="loadingScreen">
            <div class="loading">
                <div class="spinner-border" role="status"></div>
                <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ...</p>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –æ—à–∏–±–∫–∏ -->
        <div id="errorScreen" style="display: none;" class="error">
            <h4>‚ùå –û—à–∏–±–∫–∞</h4>
            <p id="errorMessage">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</p>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div id="mainContent" style="display: none;">
            <div class="telegram-card">
                <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h3>
                <p>–í–Ω–µ—Å–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</p>

                <form id="eventForm">
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è <span class="required">*</span></label>
                        <input type="text" class="form-control" id="eventTitle" required>
                        <div class="form-help">–ö—Ä–∞—Ç–∫–æ–µ –∏ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="eventDescription" rows="4"></textarea>
                        <div class="form-help">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π</div>
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">–ì–æ—Ä–æ–¥ <span class="required">*</span></label>
                                <input type="text" class="form-control" id="eventCity" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">–û–ø–ª–∞—Ç–∞ (‚ÇΩ) <span class="required">*</span></label>
                                <input type="number" class="form-control" id="eventPayment" required min="0" step="100">
                                <div class="form-help">–û–ø–ª–∞—Ç–∞ –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-7">
                            <div class="mb-3">
                                <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
                                <input type="datetime-local" class="form-control" id="eventDate">
                                <div class="form-help">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –¥–∞—Ç–∞ –≥–∏–±–∫–∞—è</div>
                            </div>
                        </div>
                        <div class="col-5">
                            <div class="mb-3">
                                <label class="form-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—á)</label>
                                <input type="number" class="form-control" id="eventDuration" min="1" max="24">
                                <div class="form-help">–†–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–¢–∏–ø —Ä–∞–±–æ—Ç—ã <span class="required">*</span></label>
                        <select class="form-select" id="workType" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞–±–æ—Ç—ã</option>
                            <option value="—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</option>
                            <option value="–ª–æ–≥–∏—Å—Ç–∏–∫–∞">üì¶ –õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è</option>
                            <option value="—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</option>
                            <option value="–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ">üí¨ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</option>
                            <option value="–ø—Ä–æ–º–æ">üì¢ –ü—Ä–æ–º–æ –∏ —Ä–µ–∫–ª–∞–º–∞</option>
                            <option value="–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ">üçΩÔ∏è –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</option>
                            <option value="–¥—Ä—É–≥–æ–µ">üîπ –î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</label>
                        <select class="form-select" id="eventStatus">
                            <option value="active">üü¢ –ê–∫—Ç–∏–≤–Ω–æ</option>
                            <option value="completed">‚ö™ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                            <option value="cancelled">üî¥ –û—Ç–º–µ–Ω–µ–Ω–æ</option>
                        </select>
                        <div class="form-help">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</div>
                    </div>

                    <button type="submit" class="telegram-button" id="submitBtn">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </form>
            </div>

            <!-- –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ -->
            <div class="telegram-card danger-zone">
                <h6>‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h6>
                <p><small>–î–µ–π—Å—Ç–≤–∏—è –≤ —ç—Ç–æ–π –∑–æ–Ω–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º—ã</small></p>
                <button type="button" class="btn-danger" onclick="deleteEvent()">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–∞–≤—Å–µ–≥–¥–∞
                </button>
            </div>
        </div>
    </div>

    <div class="navigation-menu">
        <button class="nav-btn" onclick="nav.goToOrganizerProfile()">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        <button class="nav-btn" onclick="nav.goToCreateEvent()">‚ûï –°–æ–∑–¥–∞—Ç—å</button>
        <button class="nav-btn active" onclick="nav.goToOrganizerEvents()">üìã –°–æ–±—ã—Ç–∏—è</button>
    </div>

    <script src="/static/js/role-guard.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/navigation.js"></script>
    <script>
        let tg = window.Telegram?.WebApp;
        let currentUser = null;
        let eventId = null;
        let eventData = null;

        async function init() {
            const roleCheckPassed = await roleGuard.init();
            if (!roleCheckPassed || !roleGuard.checkOrganizerAccess()) {
                return;
            }

            if (tg) {
                tg.ready();
                tg.expand();
                currentUser = tg.initDataUnsafe?.user;

                tg.MainButton.setText('üìã –ú–æ–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
                tg.MainButton.show();
                tg.MainButton.onClick(() => {
                    window.location.href = '/organizer/events';
                });
            }

            // –ü–æ–ª—É—á–∞–µ–º ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            eventId = urlParams.get('event_id');

            if (!eventId) {
                showError('ID –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω');
                return;
            }

            await loadEvent();
        }

        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };

            if (tg && tg.initData) {
                headers['Authorization'] = tg.initData;
            } else {
                headers['Authorization'] = 'test_data';
            }

            return headers;
        }

        async function loadEvent() {
            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    eventData = await response.json();

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userResponse = await fetch(`/api/auth/check?telegram_id=${currentUser.id}`, {
                        headers: getAuthHeaders()
                    });

                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        if (userData.registered && eventData.organizer_id === userData.user.id) {
                            fillForm();
                            showMainContent();
                        } else {
                            showError('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
                        }
                    } else {
                        showError('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞');
                    }
                } else {
                    showError('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                }
            } catch (error) {
                console.error('Error loading event:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
            }
        }

        function fillForm() {
            document.getElementById('eventTitle').value = eventData.title || '';
            document.getElementById('eventDescription').value = eventData.description || '';
            document.getElementById('eventCity').value = eventData.city || '';
            document.getElementById('eventPayment').value = eventData.payment || '';
            document.getElementById('workType').value = eventData.work_type || '';
            document.getElementById('eventStatus').value = eventData.status || 'active';

            if (eventData.date) {
                const date = new Date(eventData.date);
                const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('eventDate').value = localDateTime;
            }

            if (eventData.duration) {
                document.getElementById('eventDuration').value = eventData.duration;
            }
        }

        function showMainContent() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorScreen').style.display = 'block';
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º...';

            const updatedData = {
                title: document.getElementById('eventTitle').value.trim(),
                description: document.getElementById('eventDescription').value.trim(),
                city: document.getElementById('eventCity').value.trim(),
                payment: parseFloat(document.getElementById('eventPayment').value) || 0,
                date: document.getElementById('eventDate').value || null,
                duration: parseInt(document.getElementById('eventDuration').value) || null,
                work_type: document.getElementById('workType').value,
                status: document.getElementById('eventStatus').value
            };

            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(updatedData)
                });

                if (response.ok) {
                    if (tg && tg.showAlert) {
                        tg.showAlert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                    }

                    setTimeout(() => {
                        window.location.href = '/organizer/events';
                    }, 1500);

                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to update event');
                }

            } catch (error) {
                console.error('Error updating event:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
                }

                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        async function deleteEvent() {
            const confirmed = confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã:\n- –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ\n- –í—Å–µ –∑–∞—è–≤–∫–∏\n- –í—Å–µ –æ—Ç–∑—ã–≤—ã\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
            if (!confirmed) return;

            const doubleConfirm = confirm('–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!\n\n–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ù–ê–í–°–ï–ì–î–ê —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?');
            if (!doubleConfirm) return;

            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    if (tg && tg.showAlert) {
                        tg.showAlert('‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                    }
                    window.location.href = '/organizer/events';
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to delete event');
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                if (tg && tg.showAlert) {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            init();
            document.getElementById('eventForm').addEventListener('submit', handleFormSubmit);
        });
    </script>
</body>
</html>